---
- hosts: all
  # gather_facts: no

  vars_files:
  - vars/main.yml
  - vars/passwords.yml

  pre_tasks:
    - name: Set the hostname.
      hostname: name={{ hostname }}
      when: hostname is defined and hostname != 'skip'

  roles:
    - git
    - apache
    - mysql
    - php
    - php-mysql
    - composer
    - drush
    # - munin
    # - munin-node

  tasks:
    - name: Ensure that the web user exists.
      user:
        name: "{{ web_user }}"
        groups: "{{ web_server_group }}"
        append: yes
        state: present

    - name: Ensure that required directories are created.
      file:
        path: "{{ item.key }}"
        mode: "{{ item.value }}"
        owner: "{{ web_user }}"
        group: "{{ web_server_group }}"
        state: directory
        recurse: yes
      with_dict: web_dirs
